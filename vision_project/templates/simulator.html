{% extends "layout.html" %}

{% block title %}Vision Simulator{% endblock %}

{% block head_extra %}
    <style>
        .explanation-text {
            font-size: 0.85em; color: #555;
            margin-top: 5px; margin-bottom: 10px; padding-left: 18px;
        }
        .canvas-area h4 { margin-top: 20px; margin-bottom: 5px; }
        .detail-controls { text-align: center; margin-top: 5px; }
        .zoom-button {
            font-size: 1.2em; font-weight: bold;
            padding: 2px 10px; margin: 0 5px;
            cursor: pointer; user-select: none;
        }
        .ray-legend { margin-top: 20px; padding: 10px; background-color: #f8f9fa; border-radius: 5px; }
        .ray-legend p { margin: 5px 0; }
        .ray-legend .color-box {
            display: inline-block; width: 15px; height: 15px;
            vertical-align: middle; margin-right: 8px; border: 1px solid #ccc;
        }
        canvas {
            border: 1px solid #adb5bd;
            background-color: #f0f4f8;
            border-radius: 4px;
            max-width: 100%;
            height: auto;
            cursor: grab;
        }
    </style>
    <script>
        const OPTICAL_CONSTANTS = JSON.parse('{{ optical_constants | tojson | safe }}');
        const OBJECT_TYPE = "{{ object_type }}";
        const OBJECT_IMAGE_URL = "{{ object_image_url }}";
    </script>
{% endblock %}

{% block content %}
    <h2>Vision Simulator</h2>
    <p>This tool simulates how an eye focuses an image and how glasses can correct vision. A <strong>positive (+)</strong> inherent error represents <strong>Myopia</strong> (short-sightedness), and a <strong>negative (-)</strong> inherent error represents <strong>Hyperopia</strong> (long-sightedness).</p>
    
    <div class="simulator-container">
        <div class="controls">
            <h4>Eye & Object Configuration:</h4>
            <div class="control-group">
                <label for="inherentError">Simulated Eye's Inherent Error (D):</label>
                <input type="number" id="inherentError" value="2.0" step="0.25" min="-10" max="10" title="Positive for myopia, negative for hyperopia.">
                <small>E.g., +2.0 for 2D Myopia, -1.5 for 1.5D Hyperopia.</small>
            </div>
            <div class="control-group">
                <label for="objectDistance">Object Distance (m):</label>
                <input type="range" id="objectDistance" value="0.10" min="0.05" max="3" step="0.01">
                <span id="objectDistanceVal">0.1 m</span>
            </div>

            <h4>Correction Mode:</h4>
            <div class="control-group">
                <input type="radio" id="modeUncorrected" name="lensMode" value="uncorrected" checked>
                <label for="modeUncorrected"><strong>Uncorrected Eye</strong></label>
                <p class="explanation-text">Shows the eye's vision without any correction. Notice how an error results in a blurry image.</p>
            </div>
            <div class="control-group">
                <input type="radio" id="modeGlasses" name="lensMode" value="glasses">
                <label for="modeGlasses"><strong>Glasses Mode</strong></label>
                <input type="number" id="glassesRx" value="-2.0" step="0.25" disabled>
                 <p class="explanation-text">Simulates wearing glasses. A correct prescription (-1 * error) should produce a sharp image.</p>
            </div>

            <div class="ray-legend">
                <h4>Ray Diagram Legend</h4>
                <p><span class="color-box" style="background-color: #ff0000;"></span><strong>Red Rays:</strong> From object to the glasses lens.</p>
                <p><span class="color-box" style="background-color: #008000;"></span><strong>Green Rays:</strong> From glasses to the eye lens.</p>
                 <p><span class="color-box" style="background-color: #0000ff;"></span><strong>Blue Rays:</strong> Final path from eye lens to the focused image.</p>
            </div>
        </div>
        <div class="canvas-area">
            <h4>Overview (Auto-Zoom)</h4>
            <canvas id="simulatorCanvasZoomedOut" width="800" height="450"></canvas>
            <p id="infoDisplay" class="info-text"></p>
            
            <hr style="margin: 30px 0;">

            <h4>Detail View (Manual Control)</h4>
            <p><small>Use the buttons below or click-drag and mouse-wheel-scroll on the canvas.</small></p>
            <canvas id="simulatorCanvasZoomedIn" width="800" height="450"></canvas>
            <div class="detail-controls">
                <button id="zoomOutBtn" class="button-secondary zoom-button">-</button>
                <button id="zoomInBtn" class="button-secondary zoom-button">+</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts_extra %}
    <script src="{{ url_for('static', filename='js/simulator_draw.js') }}"></script>
    <script src="{{ url_for('static', filename='js/simulator_controls.js') }}"></script>
{% endblock %}