{% extends "layout.html" %}
{% block title %}Vision Demonstration{% endblock %}

{% block head_extra %}
<style>
    .controls-grid { display: grid; grid-template-columns: auto 1fr; gap: 10px 20px; align-items: center; margin-bottom:20px; max-width: 600px;}
    .controls-grid label { font-weight: bold; }
    .controls-grid input[type="range"] { width: 100%; }
    .svg-container { border: 1px solid #ccc; background-color: #f0f8ff; margin-bottom: 20px; overflow: hidden; touch-action: none;} /* Added touch-action for mobile */
    #rayDiagramDemo { display: block; width: 100%; height: auto; min-height: 300px; max-height:50vh; }
    .status-message { font-weight: bold; color: #333; min-height: 1.2em; background-color: #eee; padding: 5px; border-radius: 3px;}
    .mode-selection label { margin-right: 15px; }
</style>
{% endblock %}

{% block content %}
<section class="page-section">
    <h2>Vision Demonstration</h2>
    <p>Adjust the parameters below to see how light rays from an object are focused by the eye's lens system onto the retina.
        The <span style="color: red; font-weight:bold;">red line</span> represents the retina.
        The <span style="color: blue; font-weight:bold;">blue rays</span> originate from the top of the object.
        'F' marks the calculated focal point of these rays after passing through the lens system.
    </p>

    <div class="svg-container">
        <svg id="rayDiagramDemo" preserveAspectRatio="xMidYMid meet" viewBox="0 0 800 400"></svg>
    </div>
    <div class="status-message" id="statusMessageDemo">Initializing...</div>

    <div class="controls-grid">
        <label for="objectDistanceSlider">Object Distance (d<sub>o</sub>): <span id="objectDistanceVal">1.0</span> m</label>
        <input type="range" id="objectDistanceSlider" min="0.1" max="10" step="0.1" value="1.0">
        
        <label for="objectYOffsetSlider">Object Y-Pos (display): <span id="objectYOffsetVal">0</span> px</label>
        <input type="range" id="objectYOffsetSlider" min="-50" max="50" step="1" value="0">
        
        <hr style="grid-column: 1 / -1;">

        <fieldset style="grid-column: 1 / -1; border: 1px solid #ccc; padding:10px;">
            <legend>Eye Lens Mode</legend>
            <div class="mode-selection">
                <input type="radio" id="modePrescription" name="visionMode" value="prescription" checked>
                <label for="modePrescription">User Prescription</label>
                <input type="radio" id="modeManual" name="visionMode" value="manual_focal_length">
                <label for="modeManual">Manual Eye Lens Focal Length</label>
            </div>
        </fieldset>

        <div id="prescriptionModeControls" style="grid-column: 1 / -1;">
            <label for="userPrescriptionSlider">User's Eye Error (Rx): <span id="userPrescriptionVal">0.00</span> D</label>
            <input type="range" id="userPrescriptionSlider" min="-10" max="10" step="0.25" value="0.00">
        </div>

        <div id="manualModeControls" style="grid-column: 1 / -1; display:none;">
            <label for="eyeFocalLengthSlider">Eye Lens Focal Length (f<sub>eye</sub>): <span id="eyeFocalLengthVal">0.0167</span> m</label>
            <input type="range" id="eyeFocalLengthSlider" min="0.01" max="0.05" step="0.0001" value="{{ 1.0 / P_EYE_BASE_val | round(4) }}">
             <small>(Approx. {{ (1.0/0.01) | round(1)}}D to {{(1.0/0.05) | round(1)}}D)</small>
        </div>
        
        <hr style="grid-column: 1 / -1;">

        <label for="correctiveLensDemoSlider">Corrective Lens Power: <span id="correctiveLensDemoVal">0.00</span> D</label>
        <input type="range" id="correctiveLensDemoSlider" min="-10" max="10" step="0.25" value="0.00">
    </div>
    <p><small>Note: Object height for calculation is fixed at {{ DEFAULT_OBJECT_HEIGHT_METERS_val }}m ({{ DEFAULT_OBJECT_HEIGHT_METERS_val * 100 }}cm) from the optical axis. Y-Pos slider only affects display position.</small></p>
</section>
{% endblock %}

{% block scripts %}
<script>
    // Constants from Flask (passed via template)
    const D_RETINA_AXIAL_M = parseFloat("{{ D_RETINA_AXIAL_val }}");
    const P_EYE_BASE_D = parseFloat("{{ P_EYE_BASE_val }}");
    const DEFAULT_OBJECT_HEIGHT_M = parseFloat("{{ DEFAULT_OBJECT_HEIGHT_METERS_val }}");
    const objectImageUrl = "{{ object_image_url_initial or '' }}";
    const defaultObjectSvgUrl = "{{ default_object_svg_url }}";
</script>
<script src="{{ url_for('static', filename='js/demonstration.js') }}"></script>
{% endblock %}      